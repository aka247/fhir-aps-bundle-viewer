<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>FHIR Bundle Viewer</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <style>
    body { padding: 20px; }
    .tab-content { margin-top: 20px; }
  </style>
</head>
<body>

  <h1 id="name"></h1>
  <p id="birthdate"></p>

  <ul class="nav nav-tabs" id="tabs"></ul>
  <div class="tab-content" id="divs"></div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <script>
    function getValue(val) {
      if (!val) return "";
      if (Array.isArray(val)) return val.map(getValue).join(", ");
      if (typeof val === "object") {
        if (val.text) return val.text;
        if (val.display) return val.display;
        if (val.coding) return val.coding.map(c => c.display || c.code).join(", ");
        if (val.code) return val.code;
        if (val.value) return val.value;
        if (val.reference) return val.reference;
        return Object.values(val).map(getValue).join(", ");
      }
      return val;
    }

    function renderTable(resources) {
      if (!resources.length) return "<p><i>Keine Einträge vorhanden.</i></p>";
      const columns = Array.from(new Set(resources.flatMap(r => Object.keys(r))))
        .filter(c => !["resourceType", "id", "meta", "extension", "text"].includes(c));
      let html = "<table class='table table-striped table-hover'><thead><tr>"
               + columns.map(c => `<th>${c}</th>`).join("") + "</tr></thead><tbody>";
      resources.forEach(r => {
        html += "<tr>" + columns.map(c => `<td>${getValue(r[c])}</td>`).join("") + "</tr>";
      });
      html += "</tbody></table>";
      return html;
    }

    function hasCode(resource, code) {
      return (resource.category || []).some(cat =>
        (cat.coding || []).some(c => c.code === code)
      );
    }

    function hasClinicalStatus(resource, statusCode) {
      return (resource.clinicalStatus?.coding || []).some(c => c.code === statusCode);
    }

    function displayBundle(data) {
      const patient = data.entry.find(e => e.resource.resourceType === "Patient")?.resource;
      if (patient) {
        document.getElementById("name").textContent = (patient.name?.[0]?.text || "Patient");
        document.getElementById("birthdate").textContent = "Geburtsdatum: " + (patient.birthDate || "");
      }

      const entries = data.entry.map(e => e.resource);
      const tabs = [
        {
          id: "medikation",
          title: "Medikationsliste",
          resources: entries.filter(r =>
            ["Medication", "MedicationRequest", "MedicationStatement", "MedicationDispense", "MedicationAdministration"].includes(r.resourceType))
        },
        {
          id: "allergien",
          title: "Allergien und Intoleranzen",
          resources: entries.filter(r => r.resourceType === "AllergyIntolerance")
        },
        {
          id: "gesundheit",
          title: "Gesundheitsprobleme und Risiken",
          resources: entries.filter(r => r.resourceType === "Condition" && hasClinicalStatus(r, "active"))
        },
        {
          id: "eingriffe",
          title: "Eingriffe und Therapien",
          resources: entries.filter(r => r.resourceType === "Procedure" && hasClinicalStatus(r, "active"))
        },
        {
          id: "implantate",
          title: "Implantate, medizinische Geräte und Heilbehelfe",
          resources: entries.filter(r => ["Device", "DeviceUseStatement"].includes(r.resourceType))
        },
        {
          id: "impfungen",
          title: "Impfungen",
          resources: entries.filter(r => r.resourceType === "Immunization")
        },
        {
          id: "befunde",
          title: "Diagnostische Resultate",
          resources: entries.filter(r =>
            r.resourceType === "DiagnosticReport" ||
            (r.resourceType === "Observation" && hasCode(r, "laboratory")) ||
            (r.resourceType === "Observation" && hasCode(r, "radiology")))
        },
        {
          id: "vitalparameter",
          title: "Vitalparameter",
          resources: entries.filter(r =>
            r.resourceType === "Observation" && hasCode(r, "vital-signs"))
        },
        {
          id: "vergangen",
          title: "Vergangene Gesundheitsprobleme und Risiken",
          resources: entries.filter(r => r.resourceType === "Condition" && hasClinicalStatus(r, "resolved"))
        },
        {
          id: "beeintraechtigungen",
          title: "Beeinträchtigungen",
          resources: entries.filter(r => r.resourceType === "Condition" && hasCode(r, "248536006")) // SNOMED für Impairment
        },
        {
          id: "careplan",
          title: "Behandlungsplan",
          resources: entries.filter(r => r.resourceType === "CarePlan")
        },
        {
          id: "lebensstil",
          title: "Lebensstil / Soziale Umstände und Verhalten",
          resources: entries.filter(r =>
            r.resourceType === "Observation" &&
            (hasCode(r, "social-history") || hasCode(r, "behavioral-health")))
        },
        {
          id: "schwangerschaft",
          title: "Schwangerschaftshistorie",
          resources: entries.filter(r =>
            r.resourceType === "Observation" &&
            ["82810-3", "57075-6", "48667-8"].some(code => // LOINC pregnancy codes
              (r.code?.coding || []).some(c => c.code === code))
          )
        },
        {
          id: "willenserklaerungen",
          title: "Willenserklärungen und andere juristische Dokumente",
          resources: entries.filter(r => r.resourceType === "Consent")
        },
        {
          id: "warnungen",
          title: "Warnungen",
          resources: entries.filter(r => r.resourceType === "Flag")
        },
        {
          id: "administrativ",
          title: "Administrative Informationen",
          resources: entries.filter(r =>
            ["Patient", "Practitioner", "Organization", "CareTeam"].includes(r.resourceType))
        }
      ];

      document.getElementById("tabs").innerHTML = "";
      document.getElementById("divs").innerHTML = "";

      tabs.forEach((tab, index) => {
        if (tab.resources.length === 0) return;
        document.getElementById("tabs").innerHTML += `
          <li${index === 0 ? ' class="active"' : ''}>
            <a data-toggle="tab" href="#${tab.id}">${tab.title} <span class="badge">${tab.resources.length}</span></a>
          </li>`;
        document.getElementById("divs").innerHTML += `
          <div id="${tab.id}" class="tab-pane fade${index === 0 ? ' in active' : ''}">
            ${renderTable(tab.resources)}
          </div>`;
      });
    }

    // Beispiel-Daten laden 
    fetch("Bundle-example-iv-5.json")
      .then(res => res.json())
      .then(data => displayBundle(data))
      .catch(err => console.error("Fehler beim Laden des Bundles:", err));
  </script>

</body>
</html>
